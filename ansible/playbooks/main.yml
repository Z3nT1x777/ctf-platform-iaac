---
- name: Deploy CTF Platform
  hosts: ctf_servers
  become: yes
  vars_files:
    - ../vars/main.yml
  tasks:
    - name: Print welcome message
      debug:
        msg: "ðŸš€ DÃ©marrage du dÃ©ploiement CTF Platform..."

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - python3-pip
          - python3-docker
          - git
        state: present
    - name: Install docker-compose python module (required by Ansible)
      pip:
        name: docker-compose
        executable: pip3

    - name: Create project directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /opt/ctf
        - /opt/ctf/ctfd
        - /opt/ctf/gitlab
        - /opt/ctf/monitoring

    - name: Copy docker-compose files
      template:
        src: "../templates/docker-compose-{{ item }}.yml.j2"
        dest: "/opt/ctf/{{ item }}/docker-compose.yml"
      loop:
        - ctfd
#        - gitlab
#        - monitoring

    - name: Start CTFd
      community.docker.docker_compose:
        project_src: /opt/ctf/ctfd
        state: present

    - name: Wait for CTFd to be ready
      uri:
        url: "http://localhost:{{ ctfd_port }}"
        status_code: [200, 302]
        return_content: no
      register: result
      until: result.status in [200, 302]
      retries: 30
      delay: 10


    - name: Success message
      debug:
        msg: "âœ… CTF Platform dÃ©ployÃ©e avec succÃ¨s sur http://{{ ansible_default_ipv4.address }}"
